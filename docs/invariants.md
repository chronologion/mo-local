# Invariant Registry

This registry exists to make invariants explicit, stable, and reviewable. Each invariant should have:

- a short title (used in topic docs),
- an owner doc (where it is explained),
- and a verification link (tests) or an explicit “needs test” note.

| ID      | Title                                      | Summary                                                                                                                 | Owner Doc                                                  | Verified By                                                                                                                                            |
| ------- | ------------------------------------------ | ----------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------------ |
| INV-001 | Synced events are immutable                | Once an event has a `globalSequence`, ciphertext bytes + metadata are never rewritten.                                  | `docs/architecture/infrastructure-layer.md`                | `packages/sync-engine/__tests__/sync-engine.test.ts` (partial), `apps/api/__tests__/sync/kysely-sync-event.repository.test.ts` (persistence semantics) |
| INV-002 | Derived state uses `effectiveTotalOrder`   | Projections/read models/snapshots persist an `EffectiveCursor` in `effectiveTotalOrder`.                                | `docs/architecture/workflows.md`                           | `packages/infrastructure/__tests__/derived-state/ProjectionRuntime.test.ts`, `packages/eventstore-core/__tests__/ordering.test.ts`                     |
| INV-003 | Publish-after-commit uses `commitSequence` | `CommittedEventPublisher` publishes committed events in `commitSequence` order and checkpoints.                         | `docs/architecture/workflows.md`                           | `packages/infrastructure/__tests__/eventing/CommittedEventPublisher.test.ts`                                                                           |
| INV-004 | Sync record bytes are preserved            | Sync records persist `record_json` as TEXT and round-trip without re-stringifying; bytes are base64url.                 | `docs/architecture/infrastructure-layer.md`                | `apps/api/__tests__/sync/kysely-sync-event.repository.test.ts`                                                                                         |
| INV-005 | No causality-based ordering                | Never derive replay order from `causationId`/`correlationId` (they are tracing only).                                   | `docs/architecture/workflows.md`                           | `packages/sync-engine/__tests__/sync-engine.test.ts`                                                                                                   |
| INV-006 | ZK encryption boundary                     | Server never receives user keys and cannot decrypt payloads; it only stores/relays ciphertext.                          | `docs/security.md`                                         | `docs/security/zk-encryption-boundary-checklist.md`, `apps/api/__tests__/security/zk-boundary.test.ts`                                                 |
| INV-007 | Single-writer local DB ownership           | Per `storeId`, only one SQLite writer exists (SharedWorker default; Worker+WebLocks fallback).                          | `docs/architecture/infrastructure-layer.md`                | `apps/e2e/tests/eventstore-web-worker.test.ts` (behavior)                                                                                              |
| INV-008 | Idempotent sync facts by `eventId`         | Server append is idempotent per `eventId`; repeats return existing assignments and do not duplicate.                    | `docs/architecture/infrastructure-layer.md`                | `apps/api/__tests__/sync/kysely-sync-event.repository.test.ts`                                                                                         |
| INV-009 | Server-assigned global ordering            | Clients never guess global order; server assigns monotonically increasing `globalSequence` per stream.                  | `docs/architecture/workflows.md`                           | `apps/api/__tests__/sync/kysely-sync-event.repository.test.ts`                                                                                         |
| INV-010 | Pending rewrite preserves fact identity    | Pending rewrite during rebase keeps `eventId` + plaintext stable; re-encrypts only due to AAD/version.                  | `docs/rfcs/rfc-20260101-pending-version-rewrite-rebase.md` | `packages/sync-engine/__tests__/sync-engine.test.ts`, `packages/infrastructure/__tests__/sync/PendingEventVersionRewriter.test.ts`                     |
| INV-011 | Derived state invalidates on rebase        | When remote arrives while pending exists, derived state is reset/rebuilt deterministically.                             | `docs/architecture/workflows.md`                           | `packages/infrastructure/__tests__/derived-state/ProjectionRuntime.test.ts` (partial), `apps/e2e/tests/offline-rebase-goal-edit.test.ts` (behavior)    |
| INV-012 | Key backup enables payload recovery        | Identity + `K_aggregate` backup is sufficient to decrypt payloads/snapshots from DB/sync on restore.                    | `docs/security/key-management.md`                          | `packages/presentation/__tests__/backupEnvelope.test.ts` (format), (needs an end-to-end recovery test)                                                 |
| INV-013 | Integrity binding via AES-GCM AAD          | AES-GCM AAD binds payload ciphertext to `{aggregateId, eventType, version}` (and snapshot domain equivalents).          | `docs/security.md`                                         | `packages/infrastructure/__tests__/eventing/aad.test.ts`                                                                                               |
| INV-014 | Keys are encrypted at rest under a KEK     | Persisted key material in IndexedDB is encrypted at rest using a passphrase-derived KEK (no plaintext keys at rest).    | `docs/security/key-management.md`                          | (needs an end-to-end “keys at rest” audit/test)                                                                                                        |
| INV-015 | Diagnostics are secret-free                | Diagnostics/export flows must never include passphrases, KEKs, private keys, aggregate keys, or decrypted payloads.     | `docs/security/incident-response-and-recovery.md`          | (to be added with ALC-340 tests/checklist)                                                                                                             |
| INV-016 | Secure context required                    | Production must run in a secure context (`https://`) for WebCrypto/OPFS availability and security guarantees.           | `docs/security/browser-security.md`                        | (ops/deploy requirement)                                                                                                                               |
| INV-017 | Auth is not key escrow                     | Authentication/session state must never grant the server decryption capability; auth ≠ key escrow.                      | `docs/security/auth-and-identity.md`                       | (needs a focused review checklist)                                                                                                                     |
| INV-018 | Sync retries re-read pending from DB       | Any push retry after conflict/rebase/rewrite must re-read pending rows from SQLite (no stale in-memory snapshot).       | `docs/architecture/workflows.md`                           | `packages/sync-engine/__tests__/sync-engine.test.ts`, `apps/e2e/tests/offline-rebase-goal-edit.test.ts`                                                |
| INV-019 | Logs avoid plaintext domain content        | Logs/console output must not include decrypted payloads, user secrets, or sensitive domain fields (only safe metadata). | `docs/architecture/coding-conventions.md`                  | Review checklist (`.github/pull_request_template.md`); (consider lint/CI enforcement in `ALC-340`/`ALC-299`)                                           |

## Candidate invariants to add next

We expect this list to grow. Add invariants when they are critical to correctness/security and hard to infer from code review alone.
